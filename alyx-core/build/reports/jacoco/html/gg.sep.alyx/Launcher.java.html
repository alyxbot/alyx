<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Launcher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">alyx-core</a> &gt; <a href="index.source.html" class="el_package">gg.sep.alyx</a> &gt; <span class="el_source">Launcher.java</span></div><h1>Launcher.java</h1><pre class="source lang-java linenums">package gg.sep.alyx;

import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Optional;

import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.ParseException;
import org.apache.commons.lang3.StringUtils;
import org.beryx.textio.TextIO;
import org.beryx.textio.TextIoFactory;

import gg.sep.alyx.config.ConfigHandler;
import gg.sep.alyx.setup.AlyxSetup;
import gg.sep.alyx.startup.AlyxCommandLineParser;
import gg.sep.alyx.startup.AlyxStartupArguments;
import gg.sep.alyx.plugin.model.AlyxConfig;
import gg.sep.alyx.plugin.model.BotEntry;
import gg.sep.result.Err;
import gg.sep.result.Ok;
import gg.sep.result.Result;

/**
 * Main entry point Launcher for Alyx.
 */
public final class Launcher {

    private Launcher() { }

    /**
     * Main entry point for the Alyx application.
     *
     * @throws ParseException Exception thrown if parsing the CLI arguments failed.
     * @param args Command line arguments passed to the application.
     * @throws Exception Exception thrown during launch of the program.
     */
    public static void main(final String[] args) throws Exception {
        // parse the CLI arguments into our Startup arguments
<span class="nc" id="L39">        final CommandLine commandLine = AlyxCommandLineParser.parseArgs(args);</span>
<span class="nc" id="L40">        final AlyxStartupArguments arguments = AlyxCommandLineParser.buildArguments(commandLine);</span>

        // use the config file path if provided, otherwise use the default
<span class="nc" id="L43">        final Path configFilePath = arguments.getConfigPath().orElse(ConfigHandler.ALYX_DEFAULT_CONFIG_FILE);</span>
<span class="nc" id="L44">        final ConfigHandler configHandler = new ConfigHandler(configFilePath);</span>

        // handle setup mode or existing bot mode
<span class="nc" id="L47">        final String botName = arguments.getBotName().orElse(null);</span>
<span class="nc" id="L48">        final TextIO textIO = TextIoFactory.getTextIO();</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">        final Result&lt;BotEntry, String&gt; botEntry = arguments.isSetup() ? setup(configHandler, textIO) :</span>
<span class="nc" id="L50">            loadExisting(botName, configHandler, textIO);</span>

<span class="nc" id="L52">        textIO.dispose();</span>

<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (botEntry.isErr()) {</span>
<span class="nc" id="L55">            errorExit(botEntry.unwrapErr());</span>
        }

<span class="nc" id="L58">        AlyxBot.launchBot(botEntry.unwrap());</span>
<span class="nc" id="L59">    }</span>

    /**
     * Attempts to load an existing bot entry from the specified configuration.
     * @param botName Name of the bot to load.
     * @param configHandler Config handler instance for the config file.
     * @param textIO TextIO instance for allowing the user to select a valid bot entry from the ones in the config file.
     * @return Result of a BotEntry of loaded successfully, otherwise an error string.
     */
    public static Result&lt;BotEntry, String&gt; loadExisting(final String botName, final ConfigHandler configHandler,
                                                        final TextIO textIO) {
        // try to load the existing configuration file, or return an error if unable to do so
<span class="fc" id="L71">        final Optional&lt;AlyxConfig&gt; loadedConfig = configHandler.loadAlyxConfig();</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">        if (loadedConfig.isEmpty()) {</span>
<span class="fc" id="L73">            return Err.of(&quot;Unable to find valid configuration at: &quot; + configHandler.getConfigPath());</span>
        }
<span class="fc" id="L75">        final AlyxConfig alyxConfig = loadedConfig.get();</span>

        // if not bot is specified, provide a list of bots to load
        final String loadBotName;
<span class="fc bfc" id="L79" title="All 2 branches covered.">        if (StringUtils.isEmpty(botName)) {</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">            if (alyxConfig.getBots().isEmpty()) {</span>
<span class="fc" id="L81">                return Err.of(&quot;There are no bots configured in that config file. Run --setup&quot;);</span>
            }
<span class="fc" id="L83">            loadBotName = textIO.newStringInputReader()</span>
<span class="fc" id="L84">                .withNumberedPossibleValues(new ArrayList&lt;&gt;(alyxConfig.getBots().keySet()))</span>
<span class="fc" id="L85">                .read(&quot;Select a bot to start up:&quot;);</span>
<span class="fc" id="L86">            textIO.dispose();</span>
        } else {
<span class="fc" id="L88">            loadBotName = botName;</span>
        }
<span class="fc" id="L90">        final BotEntry botEntry = alyxConfig.getBots().get(loadBotName);</span>

<span class="fc bfc" id="L92" title="All 2 branches covered.">        if (botEntry == null) {</span>
<span class="fc" id="L93">            return Err.of(</span>
<span class="fc" id="L94">                String.format(&quot;Unable to find a bot with name '%s'. Valid Bot Names: %s&quot;, botName,</span>
<span class="fc" id="L95">                    alyxConfig.getBots().keySet()));</span>
        }
<span class="fc" id="L97">        return Ok.of(botEntry);</span>
    }

    /**
     * Enter setup mode and return the newly created Bot Entry.
     *
     * @param configHandler Config handler instance for the config file.
     * @param textIO TextIO instance for running the setup process.
     * @return Result of a BotEntry of the newly configured bot if successful, otherwise an error string.
     */
    public static Result&lt;BotEntry, String&gt; setup(final ConfigHandler configHandler, final TextIO textIO) {
<span class="nc" id="L108">        final AlyxSetup alyxSetup = AlyxSetup.builder()</span>
<span class="nc" id="L109">            .configHandler(configHandler)</span>
<span class="nc" id="L110">            .defaultDataDir(ConfigHandler.ALYX_DEFAULT_DATA_DIR)</span>
<span class="nc" id="L111">            .textIO(textIO)</span>
<span class="nc" id="L112">            .build();</span>

        // run the setup process
<span class="nc" id="L115">        return alyxSetup.startSetup();</span>
    }

    /**
     * Exits the application with an error and prints the specified message out to {@link System#out}.
     * @param error The error message to print out before exiting.
     */
    private static void errorExit(final String error) {
<span class="nc" id="L123">        System.out.println(&quot;[Error] &quot; + error);</span>
<span class="nc" id="L124">        System.exit(1);</span>
<span class="nc" id="L125">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>